% !TEX root = ../my-thesis.tex
%
\chapter{Appendix}
\label{sec:appendix}

\section{The Negative Binomial Distribution}
The negative binomial distribution is a univariate probability distribution that belongs to the discrete probability distributions. It models the number of trials required to achieve a given number of successes in a Bernoulli process. \\
The density is given by
\begin{equation}
    f\left(k,r,p\right)=\mathcal{P}\left(X=k\right)=\begin{pmatrix} k+r-1\\r-1\end{pmatrix}\left(1-p\right)^kp^r,
\end{equation}
with $r$ the number of successes, $k$ the number of failures, and $p$ the probability of success \cite{haldane1941fitting}.

\section{Code examples}
\subsubsection{Specifying the Different Types of Models}
\begin{lstlisting}[caption={Specifying different models in INLA.}, label={codeModels}, language=R]
# Specify a penalized prior
prior_1 <- list(
  prec = list(
    prior = "pc.prec",
    param = c(1, 0.01)
  )
)
# Create a neighbourhood list
nb <- poly2nb(newest_numbers_germany)
# save the neighbourhood
nb2INLA("maps/map_2.adj", nb)
# load it
g <- inla.read.graph(filename = "maps/map_2.adj")
# specify the model formula for the bym2 model
formula_bym2 <- CumNumberTestedIll ~
  # add the demographic vars and pop density
  pop_dens + urb_dens + sex + 
  # specify the model with neighbourhood matrix
  f(
    idarea_1, model = "bym2", graph = g,
    scale.model = TRUE, hyper = prior_1
  )
# compute the model
res_bym2 <- inla(
  formula_bym2,
  family = "nbinomial",
  data = newest_numbers,
  E = expected_count,
  control.predictor = list(
    compute = TRUE
  ),
  control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE)
)
# specify the model formula for besags proper spatial model
formula_bp <- CumNumberTestedIll ~
  # add the demographic vars and pop density
  pop_dens + urb_dens + sex + 
  # specify the model with neighbourhood matrix
  f(
    idarea_1, model = "besagproper",
    graph = g, hyper = prior_1
  )
# compute the model
res_bp <- inla(
  formula_bp,
  family = "nbinomial",
  data = newest_numbers,
  E = expected_count,
  control.predictor = list(
    compute = TRUE
  ),
  control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE)
)
# compute the Q matrix
Q <- Diagonal(x = sapply(nb, length))
for(i in 2:nrow(newest_numbers)) {
  Q[i - 1, i] <- -1
  Q[i, i - 1] <- -1
}
# compute the C matrix
C <- Diagonal(x = 1, n = nrow(newest_numbers)) - Q
# specify the model formula for the leroux model
formula_leroux <- CumNumberTestedIll ~
  # add the demographic vars and pop density
  pop_dens + urb_dens + sex + 
  # specify the model with neighbourhood matrix
  f(
    idarea_1, model = "generic1",
    Cmatrix = C, hyper = prior_1
  )
# compute the model
res_leroux <- inla(
  formula_leroux,
  family = "nbinomial",
  data = newest_numbers,
  E = expected_count,
  control.predictor = list(
    compute = TRUE
  ),
  control.compute = list(dic = TRUE, waic = TRUE, cpo = TRUE)
)
\end{lstlisting}
\subsubsection{Variable Selection using INLA}
\begin{lstlisting}[caption={The code for variable selection in INLA.}, label={codeSelection}, language=R]
# define the stack
stack_all <- inla.stack(
  data = list(
  CumNumberTestedIll = newest_numbers$CumNumberTestedIll
    ),
  A = list(1),
  effects = list(
    data.frame(
      Intercept = 1,
      newest_numbers[, c(2:5, 8:18, 26:36, 38:40, 43:48, 56:59)]
    )
  )
)
# run the selection
result_backwards <- INLAstep(
  fam1 = "nbinomial",
  newest_numbers,
  in_stack = stack_all,
  invariant = "Intercept",
  direction = "backwards",
  include = c(2:5, 8:18, 26:36, 38:40, 43:48, 56:59),
  y = "CumNumberTestedIll",
  y2 = "CumNumberTestedIll",
  powerl = 1,
  inter = 1,
  thresh = 2
)
# run the selection
result_forwards <- INLAstep(
  fam1 = "nbinomial",
  newest_numbers,
  in_stack = stack_all,
  invariant = "Intercept",
  direction = "forwards",
  include = c(2:5, 8:18, 26:36, 38:40, 43:48, 56:59),
  y = "CumNumberTestedIll",
  y2 = "CumNumberTestedIll",
  powerl = 1,
  inter = 1,
  thresh = 2
)
\end{lstlisting}
\subsubsection{Infrastructure Models for Germany}
\begin{lstlisting}[caption={The code for the demographic models.}, label={infraGermanyCode}, language=R]
prior_2 <- list(
  prec = list(
    prior = "pc.prec",
    param = c(0.5 / 0.31, 0.01)
  )
)
formula_22_bym2 <- CumNumberTestedIll ~
  pop_dens + urb_dens + marketplace + entertainment + sport +
  clinic + toilet + hairdresser + shops + place_of_worship +
  retail + nursing_home + restaurant + aerodrome + office +
  platform + schools + higher_education + banks + kindergarten +
  bakeries + gas + atm +
  f(
    idarea_1, model = "bym2",
    graph = g, scale.model = TRUE,
    hyper = prior_2
  ) 
formula_23_bym2 <- CumNumberTestedIll ~
  marketplace + entertainment + sport + clinic +
  toilet + hairdresser + shops + place_of_worship + retail +
  nursing_home + restaurant + aerodrome + office + platform +
  schools + higher_education + banks + kindergarten + bakeries +
  gas + atm +
  f(
    idarea_1, model = "bym2", graph = g,
    scale.model = TRUE, hyper = prior_1
  ) 
formula_26_leroux <- CumNumberTestedIll ~
  marketplace + entertainment + clinic + toilet + hairdresser +
  place_of_worship + retail + nursing_home + restaurant +
  terminal + platform + kindergarten + schools + bakeries +
  gas + banks + atm + pop_dens + higher_education +
  f(
    idarea_1, model = "generic1",
    Cmatrix = C, hyper = prior_2
  )
\end{lstlisting}
\subsubsection{Coefficients of BYM2 Model with all Variables for Germany}
\begin{table}[H] 
\caption{The fixed effects for the BYM2 model. Values are rounded. \label{allGermanyBYM2}}
\begin{tabular}{l r r r r}
\toprule
\textbf{Variable}	& \textbf{Mean}	& \textbf{exp(mean$_{\hbox{p}}$)} & \textbf{exp(q0025)} & \textbf{exp(q0975)} \\
\midrule
(Intercept) & -2.752 & 0.1308 & -5.103  & -0.407\\
AfD & 3.930 & 57.70  & 2.944 & 4.907 \\
sex & 3.726 & 436.4 & -0.5261 & 7.962 \\
Union & 0.8027 & 2.406 & 0.04095 & 1.562 \\
aerodrome & 0.3879 & 1.806 & -0.8624 & 1.635 \\
kindergarten & 0.1613 & 1.182 & -0.05895 & 0.3812 \\
entertainment & 0.1275 & 1.211 & -0.5746 & 0.8272 \\
shops & 0.06951 & 1.084 &  -0.2293 & 0.3673 \\
nursing\_home & 0.06812 & 1.144 & -0.6464 & 0.7793 \\
bakeries & 0.05613 & 1.068 & -0.2200 & 0.3315 \\
sport & 0.04839 & 1.052 &  -0.08367 & 0.1801 \\
unemployed\_ & \multirow{2}{*}{0.04093} & \multirow{2}{*}{1.042}  & \multirow{2}{*}{0.02586} & \multirow{2}{*}{0.5594}\\
foreigners  \\
asylum\_seeker\_ & \multirow{2}{*}{0.004844} & \multirow{2}{*}{1.005}  & \multirow{2}{*}{-0.005108} & \multirow{2}{*}{0.01478}\\
benefits  \\
pop\_dens & 0.00007097 & 1.000 & 0.00001480 & 0.0001270 \\
total\_income & 0.00001266 & 1.000 & -0.00003628 & 0.00006146 \\
urb\_dens & 0.000009849  & 1.0000 & -0.0006510 & 0.0006684 \\
trade\_tax &  0.0000001765 & 1.0000 & -0.00000008805 & 0.0000004411 \\
income\_tax &  -0.00006125 & 0.9999 &  -0.0002156 & 0.00009267 \\
welfare\_ & \multirow{2}{*}{-0.001508} & \multirow{2}{*}{0.9985}  & \multirow{2}{*}{-0.01493} & \multirow{2}{*}{0.01185}\\
recipients \\
protection\_ & \multirow{2}{*}{-0.003726} & \multirow{2}{*}{0.9963}  & \multirow{2}{*}{-0.007437} & \multirow{2}{*}{-0.00003260}\\
seekers \\
unemployed\_ & \multirow{2}{*}{-0.008041} & \multirow{2}{*}{0.9920}  & \multirow{2}{*}{-0.01448} & \multirow{2}{*}{-0.001612} \\
total \\
platform & -0.008767  & 0.9913 &  -0.01806 & 0.0004970 \\
schools & -0.01115  & 0.9935 & -0.2000 & 0.17773 \\
FDP & -0.01648  & 2.490 & -2.688 & 2.649 \\
restaurant & -0.03560  & 0.9654 &  -0.0931 & 0.02173 \\
clinic & -0.03697  & 0.9646 &  -0.1222 & 0.04803 \\
hairdresser & -0.05900  & 0.9483 & -0.2732 & 0.1545 \\
SPD & -0.1807  & 0.9439 &  -1.154 & 0.7900 \\
die\_linke & -0.2930  & 1.043 &  -1.897 & 1.3084 \\
other\_parties & -12.22  & 1.469e+31 & -46.58 & 22.06 \\
\bottomrule
\end{tabular}
\end{table}